<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storm Operators Manual</title>
  <style>
    @font-face{
      font-family:'VCR OSD Mono';
      src:url('../Assets/VCR_OSD_MONO_1.001.ttf') format('truetype');
      font-weight:normal;
      font-style:normal;
      font-display:swap;
    }
    body{margin:0;font-family:'VCR OSD Mono', monospace;background:#fafafa;color:#111}
    .back-btn{position:fixed;top:12px;left:12px;z-index:60;display:inline-block;background:#fafafa;border:1px solid #e5e5e5;padding:6px 10px;border-radius:6px;color:#111;text-decoration:none;font-weight:600;font-size:14px;line-height:1.2;min-width:74px;width:74px;text-align:center;box-shadow:none;font-family:'VCR OSD Mono', monospace;box-sizing:border-box}
    .back-btn:active{transform:translateY(1px)}
    .manual-viewer{max-width:1200px;margin:80px auto 60px;padding:0 24px}
    .manual-viewer__title{margin:0 0 14px;font-size:22px;line-height:1.3;font-weight:600;letter-spacing:.5px;text-align:center}
    .manual-viewer__frame{border:1px solid #d8d8d8;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,0.12);background:#fff}
    .manual-viewer__frame object{display:block;width:100%;height:1500px}
    /* pdf.js page canvas styling (preserve natural aspect ratio) */
    #pdfPages{padding:16px 0;}
    #pdfPages canvas{display:block;margin:0 auto 24px;max-width:100%;background:#fff;border:1px solid #e1e1e1;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
    /* Removed interactive PDF controls */
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width: 900px){ .manual-viewer__frame object{height:1100px} }
    /* Mobile: turn frame into scroll container with full viewport height for thumb scrolling */
    @media (max-width: 600px){
      .manual-viewer__frame{height:100vh;overflow-y:auto;-webkit-overflow-scrolling:touch;}
      .manual-viewer__frame object{height:100%;min-height:920px;}
    }
  </style>
</head>
<body>
  <script>sessionStorage.setItem('claudeSonnet45','enabled');</script>
  <script>(function(){const t=sessionStorage.getItem('authToken');if(!t){window.location.href='../Portal%20Page/MrMagic.html';}})();</script>
  <a class="back-btn" href="../Homepage/homepage.html" aria-label="Back to manuals index">‚Üê Back</a>
  <section class="manual-viewer" aria-label="Storm Operators Manual">
    <h2 class="manual-viewer__title">Storm</h2>
    <div class="manual-viewer__frame">
      <!-- Fallback object (desktop native viewer); hidden on small screens when pdf.js loads -->
      <object id="pdfObjectFallback" data="../Assets/STORM%20OPERATORS%20MANUAL%2037.pdf#view=FitH" type="application/pdf">
        <p>Cannot display PDF. <a href="../Assets/STORM%20OPERATORS%20MANUAL%2037.pdf">Open manual.</a></p>
      </object>
      <div id="pdfPages" aria-label="Storm manual full pages" style="display:none;"></div>
      <div id="pdfLoading" style="display:none;text-align:center;padding:32px 0;">
        <div style="display:inline-block;width:42px;height:42px;border:4px solid #d2d2d2;border-top-color:#111;border-radius:50%;animation:spin 1s linear infinite;"></div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js" integrity="sha512-WyQnD6G7QqB0uQMnFZqre1H+X1vEZh1MZkJX2uKJQ7npCwQSoE3o1XX6Yw1sqn/w1JvNeh5AO2gdhukwSzpUdg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      (function(){
        const pdfUrl = '../Assets/STORM%20OPERATORS%20MANUAL%2037.pdf';
        const pagesContainer = document.getElementById('pdfPages');
        const fallbackObj = document.getElementById('pdfObjectFallback');
        // Only switch to pdf.js on small screens (mobile) to address single-page issue
        const smallWidth = window.matchMedia('(max-width: 900px)').matches;
        const coarse = window.matchMedia('(pointer:coarse)').matches;
        const urlParams = new URLSearchParams(location.search);
        const forceMobile = urlParams.get('mobilePdf') === '1';
        const usePdfJs = forceMobile || smallWidth || coarse;
        if(!usePdfJs || !window['pdfjsLib']){ return; }
        // Hide fallback native viewer
        if(fallbackObj) fallbackObj.style.display = 'none';
        pagesContainer.style.display = 'block';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';
        pdfjsLib.getDocument(pdfUrl).promise.then(doc => {
          const total = doc.numPages;
          const frame = document.querySelector('.manual-viewer__frame');
          const loadingEl = document.getElementById('pdfLoading');
          const pagesContainer = document.getElementById('pdfPages');
          // Show container
          loadingEl.style.display='block';
          function computeScale(page){
            const baseViewport = page.getViewport({scale:1});
            const availWidth = (frame?frame.clientWidth:window.innerWidth) - 32;
            let scale = availWidth / baseViewport.width;
            if(scale>1.15) scale=1.15;
            return scale;
          }
          function renderPageSequential(i){
            if(i>total){ loadingEl.style.display='none'; console.log('[PDF] All pages rendered as images'); return; }
            doc.getPage(i).then(page => {
              const scale = computeScale(page);
              const viewport = page.getViewport({scale});
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              const ratio = window.devicePixelRatio||1;
              canvas.width = viewport.width * ratio;
              canvas.height = viewport.height * ratio;
              canvas.style.width = viewport.width + 'px';
              canvas.style.height = viewport.height + 'px';
              page.render({canvasContext:ctx,viewport,transform:[ratio,0,0,ratio,0,0]}).promise.then(()=>{
                // Convert to image element for simpler stacking
                const img = document.createElement('img');
                img.src = canvas.toDataURL('image/png');
                img.alt = 'Storm manual page '+i;
                img.style.display='block';
                img.style.margin='0 auto 28px';
                img.style.maxWidth='100%';
                img.style.border='1px solid #e1e1e1';
                img.style.borderRadius='4px';
                img.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)';
                pagesContainer.appendChild(img);
                // Free canvas memory reference
                canvas.width=0; canvas.height=0;
                requestAnimationFrame(()=>renderPageSequential(i+1));
              });
            }).catch(err => { console.error('[PDF] Page render error', i, err); requestAnimationFrame(()=>renderPageSequential(i+1)); });
          }
          renderPageSequential(1);
        }).catch(err => {
          console.error('[PDFJS] Failed to render as images:', err);
          if(fallbackObj) fallbackObj.style.display='block';
          pagesContainer.style.display='none';
        });
      })();
    </script>
  </section>
</body>
</html>
